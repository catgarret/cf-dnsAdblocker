name: Update Cloudflare Gateway filter lists

on:
  schedule:
    - cron: '0 3 * * 1'
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  cgps:
    runs-on: ubuntu-latest
    steps:
      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Clone repository and switch to v1 branch
        run: |
          git clone https://github.com/mrrfv/cloudflare-gateway-pihole-scripts.git
          cd cloudflare-gateway-pihole-scripts
          git checkout v1

      - name: Install npm dependencies
        run: npm ci
        working-directory: cloudflare-gateway-pihole-scripts

      - name: Download recommended whitelist
        run: bash ./get_recommended_whitelist.sh
        working-directory: cloudflare-gateway-pihole-scripts

      - name: Download recommended filters
        run: bash ./get_recommended_filters.sh
        working-directory: cloudflare-gateway-pihole-scripts

      - name: Append custom blocklists from repository variable (BLOCKLIST_URLS)
        if: ${{ vars.BLOCKLIST_URLS != '' }}
        working-directory: cloudflare-gateway-pihole-scripts
        env:
          BLOCKLIST_URLS: ${{ vars.BLOCKLIST_URLS }}
        run: |
          set -euo pipefail
          TARGET="blocklist.txt"
          touch "$TARGET"

          echo "== Current lines (recommended already applied): $(wc -l < "$TARGET") =="

          while IFS= read -r url; do
            url="$(echo "$url" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')"
            [ -z "$url" ] && continue
            case "$url" in
              \#*|\;*|\!*) continue ;;
            esac
            echo "Downloading: $url"
            curl -fsSL --retry 3 --retry-delay 2 --connect-timeout 20 "$url" >> "$TARGET"
            echo "" >> "$TARGET"
          done <<< "$BLOCKLIST_URLS"

          echo "== After append: $(wc -l < "$TARGET") lines in $TARGET =="

      - name: Delete old rules and lists
        run: |
          node cf_gateway_rule_delete.js
          node cf_list_delete.js
        working-directory: cloudflare-gateway-pihole-scripts
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_LIST_ITEM_LIMIT: ${{ secrets.CLOUDFLARE_LIST_ITEM_LIMIT }}

      - name: Create new rules and lists
        run: |
          node cf_list_create.js
          node cf_gateway_rule_create.js
        working-directory: cloudflare-gateway-pihole-scripts
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_LIST_ITEM_LIMIT: ${{ secrets.CLOUDFLARE_LIST_ITEM_LIMIT }}

      - name: Send ping request
        if: env.PING_URL != ''
        working-directory: cloudflare-gateway-pihole-scripts
        env:
          PING_URL: ${{ secrets.PING_URL }}
        run: |
          curl "${{ env.PING_URL }}"
